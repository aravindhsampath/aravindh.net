<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Aravindh.net  | ZFS performance</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.59.1" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.ab4b67a3ea25990fa8279f3b7ef08b61.css" rel="stylesheet">
    

    

    
      
    

    

    <meta property="og:title" content="ZFS performance" />
<meta property="og:description" content="A look at write performance with &amp; without compression." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://aravindh.net/post/zfs_performance/" />
<meta property="article:published_time" content="2018-07-29T17:55:47+02:00" />
<meta property="article:modified_time" content="2018-07-29T17:55:47+02:00" />
<meta itemprop="name" content="ZFS performance">
<meta itemprop="description" content="A look at write performance with &amp; without compression.">


<meta itemprop="datePublished" content="2018-07-29T17:55:47&#43;02:00" />
<meta itemprop="dateModified" content="2018-07-29T17:55:47&#43;02:00" />
<meta itemprop="wordCount" content="4392">



<meta itemprop="keywords" content="FreeBSD,ZFS,Sysadmin,disks,backup,filesystems,performance,storage,fio,compression," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ZFS performance"/>
<meta name="twitter:description" content="A look at write performance with &amp; without compression."/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
      	
        <noscript id="deferred-styles">
            <link rel="stylesheet" type="text/css" href="/css/fonts.css"/>
        </noscript>
        <script>
              var loadDeferredStyles = function() {
                var addStylesNode = document.getElementById("deferred-styles");
                var replacement = document.createElement("div");
                replacement.innerHTML = addStylesNode.textContent;
                document.body.appendChild(replacement)
                addStylesNode.parentElement.removeChild(addStylesNode);
              };
              var raf = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
                  window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
              if (raf) raf(function() { window.setTimeout(loadDeferredStyles, 0); });
              else window.addEventListener('load', loadDeferredStyles);
        </script>
    	
    	<style>
              
            .Chelsea
            {
                font-family:    'Chelsea',serif;
                font-weight:    400;
            }
             
            .Alegreya
            {
                font-family:    'Alegreya',serif;
                 
            }
            .Alegreya-sans
            {
                font-family:    'Alegreya Sans',serif;
                 
            }
            .Rancho
            {
                font-family:    'Rancho',serif;
            }
        </style>
    	<header class="bg-near-white black-80 tc pv4 avenir">
    		<h1 class="mt2 mb0 Chelsea fw4 f1 black dark-blue b">Aravindh.net</h1>
    		<div>
        		<h2 class="mt2 mb0 f6 fw4 ttu tracked Alegreya-sans">/share/mind</h2>
    		</div>
    		<nav class="bt bb tc mw7 center mt4">
        		<a class="f6 f5-l fw5 link bg-animate black-80 hover-bg-light-green dib pa3 ph4-l Alegreya-sans" href="/">Home</a>
        		<a class="f6 f5-l fw5 link bg-animate black-80 hover-bg-light-green dib pa3 ph4-l Alegreya-sans" href="/about/">About</a>
        		<a class="f6 f5-l fw5 link bg-animate black-80 hover-bg-light-green dib pa3 ph4-l Alegreya-sans" href="/shelf/">Shelf</a>
            <a class="f6 f5-l fw5 link bg-animate black-80 hover-bg-light-green dib pa3 ph4-l Alegreya-sans" href="/wiki/">Wiki</a>
        		<a class="f6 f5-l fw5 link bg-animate black-80 hover-bg-light-green dib pa3 ph4-l Alegreya-sans" href="/projects/">Projects</a>
        		<a class="f6 f5-l fw5 link bg-animate black-80 hover-bg-light-green dib pa3 ph4-l Alegreya-sans" href="/contact/">Contact</a>
   			</nav>
   			<main class="mw6 center pt2">
	    		<article class="dt w-100 b--black-05 pb2 mt2" href="#0">
	    			<div class="dtc w2 w3-ns v-mid">
	        			<img src="/images/authorimage.png" class="ba b--black-10 db br2 w2 w3-ns h2 h3-ns"/>
	      			</div>
	      			<div class="dtc v-mid pl3 Alegreya-sans">
	        			<h1 class="f6 f5-ns fw6 lh-title black mv0 tl">Aravindh Sampathkumar </h1>
	        			<a class="no-underline" href="https://twitter.com/reacharavindh"><h2 class="f6 fw4 mt0 mb0 blue tl">@reacharavindh</h2></a>
	        			<h2 class="f6 fw6 lh-title black-70 mv0 tl"> Performance Engineer and Sysadmin | Ex @NetApp </h2>
	        			<h2 class="f6 fw4 mt0 mb0 black-60 tl">Jack of many trades and aspiring master of some, all around good guy to have on your team.</h2>
	      			</div>
	    		</article>
			</main>
		</header>

    <main class="pb3" role="main">
      


<article class="mw8 mw8-ns center bg-near-white">
  <div class="flex flex-column flex-row-ns">
    <div class="pa2 pa0-ns pr3-ns mb2 mb0-ns w-100 w-30-ns">
      <img src="/images/zfs_performance.png" class="db" alt="Featured image of this post">
    </div>
    <div class="w-100 w-70-ns mw6-ns pl2 pl3-ns">
      <a class="no-underline black" href="/post/zfs_performance/">
        <h1 class="f2 fw5 Alegreya mb1">ZFS performance</h1>
        <time class="f6 mv1 dib tracked Alegreya-sans" datetime="2018-07-29T17:55:47&#43;02:00">July 29, 2018</time>
        <p class="f6 lh-copy mv0 Alegreya-sans">By Aravindh Sampathkumar</p>
      </a>
    </div>
  </div>
</article>

<main class="mw6 mw8-ns center bg-near-white">
  <div class="flex flex-column flex-row-ns">
    <div class="pa2 pa0-ns mt4-ns w-100 w-70-ns f6 f5-ns Alegreya lh-copy center">

<h3 id="context">Context</h3>

<p>This is NOT an all-in post about ZFS performance. I built <a href="/posts/zfs_fileserver/">a FreeBSD+ZFS file server</a> recently at work to serve as an offsite backup server. I wanted to run a few synthetic workloads on it and look at how it fares from performance perspective. Mostly for curiosity and learning purposes.</p>

<h3 id="performance">Performance</h3>

<p>As stated in the notes about building this server, performance was not one of the priorities, as this server will never face our active workload. What I care about from this server is its ability to work with rsync and keep the data synchronised with our primary storage server. With that context, I ran a few write tests to see how good our solution is and what to expect from it in terms of performance.</p>

<p>When it comes to storage performance, there are two important metrics that stand above all. Throughput and Latency. In simple words, throughput, measured in MiB/s is the maximum amount of data the system can transfer in/out per time. Latency or response time, measured in microseconds or milliseconds is the amount of time taken for an io to complete.</p>

<h3 id="methodology">Methodology</h3>

<p>Coming from a storage performance engineering background, here is how I approach performance benchmarking.</p>

<p>The goal of benchmarking is to simulate as realistically as possible the workflow that the system is going to support, measure the performance of the system and its subsystems, identify bottlenecks, tune subsystems one by one, effectively removing all bottlenecks until desired performance goals are achieved or reaching a state where a bottleneck cannot be removed without physcical change to the system.</p>

<p>All that said, I dont intend to spend my time removing all bottlenecks in our ZFS system and make it the fastest ever!. My goal for this post is only on the <strong>measure</strong> phase of the cycle. Lets get started.</p>

<p>What attributes do I care about?</p>

<ol>
<li>Sequential write - to see how good the server will handle the data coming in from our primary server through rsync.</li>
<li>Sequential read - for when I need to restore files from this server to the primary(less important).</li>
</ol>

<p>I dont care about random read/write, unlink/delete and meta data performance.</p>

<h3 id="write-performance-with-fio">Write performance with fio</h3>

<p><a href="http://fio.readthedocs.io/en/latest/fio_doc.html">Fio - Flexible I/O tester</a></p>

<div class="dt center pb1">
  <div class="db dtc-ns v-mid-ns">
    <img src="/images/fio.png" alt="FIO - Flexible IO tester" class="w-100 mw7 w5-ns" />
  </div>
  <div class="db dtc-ns v-mid ph2 pr0-ns pl3 pl4-ns">
    <p class="lh-copy">
      Fio is an I/O testing tool that can spawn a number of threads or processes doing a particular type of I/O action as specified by the user, and report I/O performance in many useful ways. Our focus is on throughput and latency.   
    </p>
  </div>
</div>

<p>Our goal here is to measure sequential write performance. I&rsquo;m going to assume block size to be 128 KiB as ZFS default record size is 128K.</p>

<h4 id="test-setup">Test setup:</h4>

<p>Install fio as per instructions on its website. Prepare a job file - write_test.fio that we can customise for several tests.</p>

<pre><code class="language-bash">root@delorean:/sec_stor/backup/fiotest/fio-master # nano write_test.fio
; seq_write test
[global]
rw=write
kb_base=1024
bs=128k
size=2m
runtime=180
iodepth=1
directory=/sec_stor/backup/fiotest/
numjobs=1
buffer_compress_percentage=100
refill_buffers
buffer_compress_chunk=131072
buffer_pattern=0xdeadbeef
end_fsync=true
group_reporting

[test1]
</code></pre>

<p>Where,</p>

<p><code>kb_base</code> instructs fio to use the binary prefix system instead of the decimal base(Kibibytes(1024 bytes) instead of kilobytes(1000 bytes)).</p>

<p><code>bs</code> is blocksize and is set to 128 KiB.</p>

<p><code>size</code> is file size and is set to 2 MiB.</p>

<p><code>iodepth</code> - we&rsquo;re running on FreeBSD. AFAIK, default ioengine is psync, and iodepth defaults to <code>1</code>.</p>

<p><code>directory</code> specifies where test files are created.
numjobs is our tunable for unit of work. Example, <code>10</code> will instruct Fio to spawn <code>10</code> processes each independently working on it&rsquo;s own file of size - file size specified earlier.</p>

<p><code>numjobs</code> is the number of processes that FIO spawns to generate IO. Each of the spawned process will create a file of size specified earlier, and generate IO to that file independent of other processes.</p>

<p><code>buffer_compress_percentage</code> is the knob that controls the compressibility of the generated data.</p>

<p><code>refill_buffers</code> instructs FIO to refill the buffer with random data on every submit instead of re-using the buffer contents.</p>

<p><code>buffer_compress_chunk</code> is simply the size of the compressible pattern. I chose to match it with ZFS record legth which is 128K or 131072 bytes.</p>

<p><code>buffer_pattern</code> is the pattern to use for compressible data. Needs to be specified to prevent FIO default of using zeroes.</p>

<p><code>end_fsync</code> instructs FIO to fsync the file contents when a write stage has completed.</p>

<p><code>group_reporting</code> is to aggregate results of all processes.</p>

<p>Lets run it once to see if it generates 100% compressible data&hellip;</p>

<pre><code class="language-bash">root@delorean:/sec_stor/backup/fiotest/fio-master # rm -rf ../test1.* ; sleep 1 ; ./fio write_test.fio
test1: (g=0): rw=write, bs=(R) 128KiB-128KiB, (W) 128KiB-128KiB, (T) 128KiB-128KiB, ioengine=psync, iodepth=1
fio-3.8
Starting 1 process
test1: Laying out IO file (1 file / 2MiB)

test1: (groupid=0, jobs=1): err= 0: pid=86394: Sun Jul 29 00:07:47 2018
  write: IOPS=8000, BW=1000MiB/s (1049MB/s)(2048KiB/2msec)
    clat (usec): min=68, max=122, avg=74.98, stdev=13.10
     lat (usec): min=68, max=123, avg=75.20, stdev=13.28
    clat percentiles (usec):
     |  1.00th=[   69],  5.00th=[   69], 10.00th=[   69], 20.00th=[   71],
     | 30.00th=[   71], 40.00th=[   71], 50.00th=[   72], 60.00th=[   72],
     | 70.00th=[   73], 80.00th=[   76], 90.00th=[   84], 95.00th=[  123],
     | 99.00th=[  123], 99.50th=[  123], 99.90th=[  123], 99.95th=[  123],
     | 99.99th=[  123]
  lat (usec)   : 100=93.75%, 250=6.25%
  cpu          : usr=200.00%, sys=0.00%, ctx=0, majf=0, minf=0
  IO depths    : 1=100.0%, 2=0.0%, 4=0.0%, 8=0.0%, 16=0.0%, 32=0.0%, &gt;=64=0.0%
     submit    : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%
     complete  : 0=0.0%, 4=100.0%, 8=0.0%, 16=0.0%, 32=0.0%, 64=0.0%, &gt;=64=0.0%
     issued rwts: total=0,16,0,0 short=0,0,0,0 dropped=0,0,0,0
     latency   : target=0, window=0, percentile=100.00%, depth=1

Run status group 0 (all jobs):
  WRITE: bw=1000MiB/s (1049MB/s), 1000MiB/s-1000MiB/s (1049MB/s-1049MB/s), io=2048KiB (2097kB), run=2-2msec
</code></pre>

<p>Where,</p>

<p><code>clat</code> is completion latency, and we can see this test saw min of <code>68 us</code> and average of <code>74.98 us</code>.</p>

<p><code>bw</code> is throughput and this test achieved <code>1000MiB/s</code></p>

<p>However, this was just an example test to manually verify that everything works as intended. Lets view the file it created..</p>

<pre><code class="language-bash">root@delorean:/sec_stor/backup/fiotest/fio-master # ls -alh ../test1.0.0 
-rw-r--r--  1 root  wheel   2.0M Jul 29 00:07 ../test1.0.0
</code></pre>

<p>So, it did create a 2 MiB file as we expected.</p>

<p>Let&rsquo;s see how much space this file actually uses in the disk&hellip;</p>

<pre><code class="language-bash">root@delorean:/sec_stor/backup/fiotest/fio-master # du -sh ../test1.0.0
165K  ../test1.0.0
</code></pre>

<p>Nice. Our ZFS system compressed this 2 MiB file down to 165 KiB because it was generated with 100% compressibility setting.</p>

<p>Let&rsquo;s peek into the file to see what content was generated..</p>

<pre><code class="language-bash">root@delorean:/sec_stor/backup/fiotest/fio-master # hexdump -C ../test1.0.0 |less
00000000  de ad be ef de ad be ef  de ad be ef de ad be ef  |................|
*
00200000
(END)
</code></pre>

<p>It&rsquo;s our requested pattern in the entire file because we asked for 100% compression.
Let&rsquo;s modify this test slightly to make it generate 0% compressible data..</p>

<p>Modifying the write_test.fio file with following changes,</p>

<pre><code class="language-bash">buffer_compress_percentage=100
buffer_pattern=0xdeadbeef
</code></pre>

<p>to</p>

<pre><code class="language-bash">buffer_compress_percentage=0
;buffer_pattern=0xdeadbeef ; this is commented out.
</code></pre>

<p>Repeat the run :</p>

<pre><code class="language-bash">root@delorean:/sec_stor/backup/fiotest/fio-master # rm -rf ../test1.* ; sleep 1 ; ./fio write_test.fio
test1: (g=0): rw=write, bs=(R) 128KiB-128KiB, (W) 128KiB-128KiB, (T) 128KiB-128KiB, ioengine=psync, iodepth=1
fio-3.8
Starting 1 process
~ ~ ~ ~ ~ ~ ~ ~ Timmed for brevity.
</code></pre>

<p>check actual usage on disk,</p>

<pre><code class="language-bash">root@delorean:/sec_stor/backup/fiotest/fio-master # du -sh ../test1.0.0
2.0M  ../test1.0.0
</code></pre>

<p>It is using all of 2 MiB because it was not compressible as we expected.</p>

<pre><code class="language-bash">root@delorean:/sec_stor/backup/fiotest/fio-master # hexdump -C ../test1.0.0 | less
00000000  a8 71 09 48 d3 ad 5f c5  35 2e 2d b0 b5 51 5a 13  |.q.H.._.5.-..QZ.|
00000010  c6 25 eb 1e 20 72 c3 13  b8 64 fa 70 ce 5e 52 18  |.%.. r...d.p.^R.|
00000020  97 4c c3 9b 5c 13 ab 06  92 e9 2c ed 89 14 88 15  |.L..\.....,.....|
00000030  32 9d dc c8 fa 0b ea 1e  a6 93 82 0a 11 dd bd 05  |2...............|
00000040  74 52 7d d7 60 36 39 0a  4e aa b5 71 0d bb 42 1a  |tR}.`69.N..q..B.|
00000050  49 b5 0f d9 86 9e 63 12  a9 76 7d 00 49 07 c8 09  |I.....c..v}.I...|
~ ~ ~ ~ ~ ~ ~ ~ Timmed for brevity.
</code></pre>

<p>As expected, file is filled with random data which was not compressible.</p>

<p>Based on this setup, I set up a few tests by varying two parameters, compressibility and load(numfiles). Here is how my test matrix looks like..</p>

<div class="overflow-auto">
    <table class="f6 w-100 mw8 center helvetica" cellspacing="0">
      <thead>
        <tr>
          <th class="fw6 bb b--black-20 tl pb3 pr3 bg-white"> </th>
          <th class="fw6 bb b--black-20 tl pb3 pr3 bg-white">0% compressibility</th>
          <th class="fw6 bb b--black-20 tl pb3 pr3 bg-white">50% compressibility</th>
          <th class="fw6 bb b--black-20 tl pb3 pr3 bg-white">100% compressibility</th>
        </tr>
      </thead>
      <tbody class="lh-copy">
        <tr>
          <td class="pv1 pr3 bb b--black-20">1 Proc <br> (1 X 128 GiB) <br> dataset size = 128 GiB</td>
          <td class="pv1 pr3 bb b--black-20 tc">TBD</td>
          <td class="pv1 pr3 bb b--black-20 tc">TBD</td>
          <td class="pv1 pr3 bb b--black-20 tc">TBD</td>
        </tr>
        <tr>
          <td class="pv1 pr3 bb b--black-20">2 Procs <br> (2 X 128 GiB) <br> dataset size = 256 GiB</td>
          <td class="pv1 pr3 bb b--black-20 tc">TBD</td>
          <td class="pv1 pr3 bb b--black-20 tc">TBD</td>
          <td class="pv1 pr3 bb b--black-20 tc">TBD</td>
        </tr>
        <tr>
          <td class="pv1 pr3 bb b--black-20">3 Proc <br> (3 X 128 GiB) <br> dataset size = 384 GiB</td>
          <td class="pv1 pr3 bb b--black-20 tc">TBD</td>
          <td class="pv1 pr3 bb b--black-20 tc">TBD</td>
          <td class="pv1 pr3 bb b--black-20 tc">TBD</td>
        </tr>
        <tr>
          <td class="pv1 pr3 bb b--black-20">. . . . . . </td>
          <td class="pv1 pr3 bb b--black-20 tc">TBD</td>
          <td class="pv1 pr3 bb b--black-20 tc">TBD</td>
          <td class="pv1 pr3 bb b--black-20 tc">TBD</td>
        </tr>
        <tr>
          <td class="pv1 pr3 bb b--black-20">9 Proc <br> (9 X 128 GiB) <br> dataset size = 896 GiB</td>
          <td class="pv1 pr3 bb b--black-20 tc">TBD</td>
          <td class="pv1 pr3 bb b--black-20 tc">TBD</td>
          <td class="pv1 pr3 bb b--black-20 tc">TBD</td>
        </tr>
      </tbody>
    </table>
  </div>

<p>Note: data set set size increases in steps of 128 GiB along with the number of processes.</p>

<p>Keep in mind that my test system has 768 GiB of memory. So I tailored my test in a way that my dataset gets bigger than the total amount of memory at some point during the test.</p>

<div class="mw7-ns w-100">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<div id="08fd11cf-2296-4698-8d6c-14c98530e550" style="height: 100%; width: 100%;" class="plotly-graph-div"></div><script type="text/javascript">window.PLOTLYENV=window.PLOTLYENV || {};window.PLOTLYENV.BASE_URL="https://plot.ly";Plotly.newPlot("08fd11cf-2296-4698-8d6c-14c98530e550", [{"type": "bar", "x": [1623, 2597, 2954, 2798, 2528, 2708, 2625, 2565, 2674], "y": ["1 Proc <br> (1 X 128 GiB)", "2 Proc <br> (2 X 128 GiB)", "3 Proc <br> (3 X 128 GiB)", "4 Proc <br> (4 X 128 GiB)", "5 Proc <br> (5 X 128 GiB)", "6 Proc <br> (6 X 128 GiB)", "7 Proc <br> (7 X 128 GiB)", "8 Proc <br> (8 X 128 GiB)", "9 Proc <br> (9 X 128 GiB)"], "marker": {"color": "rgba(50, 171, 96, 0.6)", "line": {"color": "rgba(50, 171, 96, 1.0)", "width": 1}}, "name": "Average throuhput from duration of test in MiB/s (Higher is better)", "orientation": "h", "xaxis": "x1", "yaxis": "y1"}, {"type": "scatter", "x": [44.56, 60.52, 90.47, 139, 206.3, 233.92, 291.93, 349.8, 378.81], "y": ["1 Proc <br> (1 X 128 GiB)", "2 Proc <br> (2 X 128 GiB)", "3 Proc <br> (3 X 128 GiB)", "4 Proc <br> (4 X 128 GiB)", "5 Proc <br> (5 X 128 GiB)", "6 Proc <br> (6 X 128 GiB)", "7 Proc <br> (7 X 128 GiB)", "8 Proc <br> (8 X 128 GiB)", "9 Proc <br> (9 X 128 GiB)"], "mode": "lines+markers", "line": {"color": "rgb(128, 0, 128)"}, "name": "Average completion latency in us (Lower is better)", "xaxis": "x2", "yaxis": "y2"}], {"xaxis1": {"domain": [0.0, 0.45], "anchor": "y1"}, "yaxis1": {"domain": [0.0, 1.0], "anchor": "x1"}, "xaxis2": {"domain": [0.47, 1], "anchor": "y2", "zeroline": false, "showline": false, "showticklabels": true, "showgrid": true, "dtick": 25000, "title": "<b>latency</b>"}, "yaxis2": {"domain": [0, 0.85], "anchor": "x2", "showgrid": false, "showline": true, "showticklabels": false, "linecolor": "rgba(102, 102, 102, 0.8)", "linewidth": 2}, "title": "<b>FIO - sequential write performance at 0% compressibility</b>", "yaxis": {"showgrid": false, "showline": false, "showticklabels": true, "domain": [0, 0.85]}, "xaxis": {"zeroline": false, "showline": false, "showticklabels": true, "showgrid": true, "domain": [0, 0.42], "title": "<b>Avg. Throughput</b>"}, "legend": {"x": 0.029, "y": 1.038, "font": {"size": 10}}, "margin": {"l": 100, "r": 20, "t": 70, "b": 100}, "paper_bgcolor": "rgb(248, 248, 255)", "plot_bgcolor": "rgb(248, 248, 255)", "annotations": [{"xref": "x2", "yref": "y2", "y": "1 Proc <br> (1 X 128 GiB)", "x": 25.0, "text": "45.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "1 Proc <br> (1 X 128 GiB)", "x": 1626, "text": "1623MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "2 Proc <br> (2 X 128 GiB)", "x": 41.0, "text": "61.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "2 Proc <br> (2 X 128 GiB)", "x": 2600, "text": "2597MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "3 Proc <br> (3 X 128 GiB)", "x": 70.0, "text": "90.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "3 Proc <br> (3 X 128 GiB)", "x": 2957, "text": "2954MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "4 Proc <br> (4 X 128 GiB)", "x": 119.0, "text": "139.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "4 Proc <br> (4 X 128 GiB)", "x": 2801, "text": "2798MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "5 Proc <br> (5 X 128 GiB)", "x": 186.0, "text": "206.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "5 Proc <br> (5 X 128 GiB)", "x": 2531, "text": "2528MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "6 Proc <br> (6 X 128 GiB)", "x": 214.0, "text": "234.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "6 Proc <br> (6 X 128 GiB)", "x": 2711, "text": "2708MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "7 Proc <br> (7 X 128 GiB)", "x": 272.0, "text": "292.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "7 Proc <br> (7 X 128 GiB)", "x": 2628, "text": "2625MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "8 Proc <br> (8 X 128 GiB)", "x": 330.0, "text": "350.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "8 Proc <br> (8 X 128 GiB)", "x": 2568, "text": "2565MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "9 Proc <br> (9 X 128 GiB)", "x": 359.0, "text": "379.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "9 Proc <br> (9 X 128 GiB)", "x": 2677, "text": "2674MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}]}, {"showLink": false, "linkText": "Export to plot.ly"})</script>
</div>
<div class="dt center pt2 pb1">
  <div class="db dtc-ns v-mid-ns">
    <img src="/images/util_curve.png" alt="Utilisation hockey stick curve" class="w-100 mw7 w5-ns" />
  </div>
  <div class="db dtc-ns v-mid ph2 pr0-ns pl3 pl4-ns">
    <p class="lh-copy">
      What we see here is an example of what we call the hockey stick curve in performance engineering & queueing theory. Assuming constant service time, and constant arrival times, the queueing delay and hence response time follows this hockey stick curve. Once throughput hits a ceiling, the response times/latencies shoot up dramatically. The above chart is not as dramatic as the hockey stick because we're looking at averages of both throughput and latencies. 
    </p>
  </div>
</div>

<div class="mw7-ns w-100 pb2">
<div id="dd45d8a2-94f8-4b26-addc-56f572e5307d" style="height: 100%; width: 100%;" class="plotly-graph-div"></div><script type="text/javascript">window.PLOTLYENV=window.PLOTLYENV || {};window.PLOTLYENV.BASE_URL="https://plot.ly";Plotly.newPlot("dd45d8a2-94f8-4b26-addc-56f572e5307d", [{"type": "bar", "x": [1757, 2623, 2050, 2122, 2388, 2414, 2210, 2295, 2332], "y": ["1 Proc <br> (1 X 128 GiB)", "2 Proc <br> (2 X 128 GiB)", "3 Proc <br> (3 X 128 GiB)", "4 Proc <br> (4 X 128 GiB)", "5 Proc <br> (5 X 128 GiB)", "6 Proc <br> (6 X 128 GiB)", "7 Proc <br> (7 X 128 GiB)", "8 Proc <br> (8 X 128 GiB)", "9 Proc <br> (9 X 128 GiB)"], "marker": {"color": "rgba(50, 171, 96, 0.6)", "line": {"color": "rgba(50, 171, 96, 1.0)", "width": 1}}, "name": "Average throuhput from duration of test in MiB/s (Higher is better)", "orientation": "h", "xaxis": "x1", "yaxis": "y1"}, {"type": "scatter", "x": [50.11, 70.23, 152.52, 202.34, 246.85, 278.62, 363.83, 401.17, 447.02], "y": ["1 Proc <br> (1 X 128 GiB)", "2 Proc <br> (2 X 128 GiB)", "3 Proc <br> (3 X 128 GiB)", "4 Proc <br> (4 X 128 GiB)", "5 Proc <br> (5 X 128 GiB)", "6 Proc <br> (6 X 128 GiB)", "7 Proc <br> (7 X 128 GiB)", "8 Proc <br> (8 X 128 GiB)", "9 Proc <br> (9 X 128 GiB)"], "mode": "lines+markers", "line": {"color": "rgb(128, 0, 128)"}, "name": "Average completion latency in us (Lower is better)", "xaxis": "x2", "yaxis": "y2"}], {"xaxis1": {"domain": [0.0, 0.45], "anchor": "y1"}, "yaxis1": {"domain": [0.0, 1.0], "anchor": "x1"}, "xaxis2": {"domain": [0.47, 1], "anchor": "y2", "zeroline": false, "showline": false, "showticklabels": true, "showgrid": true, "dtick": 25000, "title": "<b>latency</b>"}, "yaxis2": {"domain": [0, 0.85], "anchor": "x2", "showgrid": false, "showline": true, "showticklabels": false, "linecolor": "rgba(102, 102, 102, 0.8)", "linewidth": 2}, "title": "<b>FIO - sequential write performance at 50% compressibility</b>", "yaxis": {"showgrid": false, "showline": false, "showticklabels": true, "domain": [0, 0.85]}, "xaxis": {"zeroline": false, "showline": false, "showticklabels": true, "showgrid": true, "domain": [0, 0.42], "title": "<b>Avg. Throughput</b>"}, "legend": {"x": 0.029, "y": 1.038, "font": {"size": 10}}, "margin": {"l": 100, "r": 20, "t": 70, "b": 100}, "paper_bgcolor": "rgb(248, 248, 255)", "plot_bgcolor": "rgb(248, 248, 255)", "annotations": [{"xref": "x2", "yref": "y2", "y": "1 Proc <br> (1 X 128 GiB)", "x": 30.0, "text": "50.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "1 Proc <br> (1 X 128 GiB)", "x": 1760, "text": "1757MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "2 Proc <br> (2 X 128 GiB)", "x": 50.0, "text": "70.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "2 Proc <br> (2 X 128 GiB)", "x": 2626, "text": "2623MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "3 Proc <br> (3 X 128 GiB)", "x": 133.0, "text": "153.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "3 Proc <br> (3 X 128 GiB)", "x": 2053, "text": "2050MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "4 Proc <br> (4 X 128 GiB)", "x": 182.0, "text": "202.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "4 Proc <br> (4 X 128 GiB)", "x": 2125, "text": "2122MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "5 Proc <br> (5 X 128 GiB)", "x": 227.0, "text": "247.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "5 Proc <br> (5 X 128 GiB)", "x": 2391, "text": "2388MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "6 Proc <br> (6 X 128 GiB)", "x": 259.0, "text": "279.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "6 Proc <br> (6 X 128 GiB)", "x": 2417, "text": "2414MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "7 Proc <br> (7 X 128 GiB)", "x": 344.0, "text": "364.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "7 Proc <br> (7 X 128 GiB)", "x": 2213, "text": "2210MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "8 Proc <br> (8 X 128 GiB)", "x": 381.0, "text": "401.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "8 Proc <br> (8 X 128 GiB)", "x": 2298, "text": "2295MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "9 Proc <br> (9 X 128 GiB)", "x": 427.0, "text": "447.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "9 Proc <br> (9 X 128 GiB)", "x": 2335, "text": "2332MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}]}, {"showLink": false, "linkText": "Export to plot.ly"})</script>
</div>

<p>and finally, fully compressible data..</p>

<div class="mw7-ns w-100 pb2">
  <div id="51f85019-3ca6-4333-a67a-a4c6b4282747" style="height: 100%; width: 100%;" class="plotly-graph-div"></div><script type="text/javascript">window.PLOTLYENV=window.PLOTLYENV || {};window.PLOTLYENV.BASE_URL="https://plot.ly";Plotly.newPlot("51f85019-3ca6-4333-a67a-a4c6b4282747", [{"type": "bar", "x": [2491, 4606, 5950, 6154, 6548, 6592, 6510, 6278, 6378], "y": ["1 Proc <br> (1 X 128 GiB)", "2 Proc <br> (2 X 128 GiB)", "3 Proc <br> (3 X 128 GiB)", "4 Proc <br> (4 X 128 GiB)", "5 Proc <br> (5 X 128 GiB)", "6 Proc <br> (6 X 128 GiB)", "7 Proc <br> (7 X 128 GiB)", "8 Proc <br> (8 X 128 GiB)", "9 Proc <br> (9 X 128 GiB)"], "marker": {"color": "rgba(50, 171, 96, 0.6)", "line": {"color": "rgba(50, 171, 96, 1.0)", "width": 1}}, "name": "Average throuhput from duration of test in MiB/s (Higher is better)", "orientation": "h", "xaxis": "x1", "yaxis": "y1"}, {"type": "scatter", "x": [44, 47, 55, 68, 85, 103, 122, 145, 168], "y": ["1 Proc <br> (1 X 128 GiB)", "2 Proc <br> (2 X 128 GiB)", "3 Proc <br> (3 X 128 GiB)", "4 Proc <br> (4 X 128 GiB)", "5 Proc <br> (5 X 128 GiB)", "6 Proc <br> (6 X 128 GiB)", "7 Proc <br> (7 X 128 GiB)", "8 Proc <br> (8 X 128 GiB)", "9 Proc <br> (9 X 128 GiB)"], "mode": "lines+markers", "line": {"color": "rgb(128, 0, 128)"}, "name": "Average completion latency in us (Lower is better)", "xaxis": "x2", "yaxis": "y2"}], {"xaxis1": {"domain": [0.0, 0.45], "anchor": "y1"}, "yaxis1": {"domain": [0.0, 1.0], "anchor": "x1"}, "xaxis2": {"domain": [0.47, 1], "anchor": "y2", "zeroline": false, "showline": false, "showticklabels": true, "showgrid": true, "dtick": 25000, "title": "<b>latency</b>"}, "yaxis2": {"domain": [0, 0.85], "anchor": "x2", "showgrid": false, "showline": true, "showticklabels": false, "linecolor": "rgba(102, 102, 102, 0.8)", "linewidth": 2}, "title": "<b>FIO - sequential write performance at 100% compressibility</b>", "yaxis": {"showgrid": false, "showline": false, "showticklabels": true, "domain": [0, 0.85]}, "xaxis": {"zeroline": false, "showline": false, "showticklabels": true, "showgrid": true, "domain": [0, 0.42], "title": "<b>Avg. Throughput</b>"}, "legend": {"x": 0.029, "y": 1.038, "font": {"size": 10}}, "margin": {"l": 100, "r": 20, "t": 70, "b": 100}, "paper_bgcolor": "rgb(248, 248, 255)", "plot_bgcolor": "rgb(248, 248, 255)", "annotations": [{"xref": "x2", "yref": "y2", "y": "1 Proc <br> (1 X 128 GiB)", "x": 24.0, "text": "44.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "1 Proc <br> (1 X 128 GiB)", "x": 2494, "text": "2491MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "2 Proc <br> (2 X 128 GiB)", "x": 27.0, "text": "47.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "2 Proc <br> (2 X 128 GiB)", "x": 4609, "text": "4606MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "3 Proc <br> (3 X 128 GiB)", "x": 35.0, "text": "55.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "3 Proc <br> (3 X 128 GiB)", "x": 5953, "text": "5950MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "4 Proc <br> (4 X 128 GiB)", "x": 48.0, "text": "68.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "4 Proc <br> (4 X 128 GiB)", "x": 6157, "text": "6154MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "5 Proc <br> (5 X 128 GiB)", "x": 65.0, "text": "85.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "5 Proc <br> (5 X 128 GiB)", "x": 6551, "text": "6548MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "6 Proc <br> (6 X 128 GiB)", "x": 83.0, "text": "103.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "6 Proc <br> (6 X 128 GiB)", "x": 6595, "text": "6592MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "7 Proc <br> (7 X 128 GiB)", "x": 102.0, "text": "122.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "7 Proc <br> (7 X 128 GiB)", "x": 6513, "text": "6510MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "8 Proc <br> (8 X 128 GiB)", "x": 125.0, "text": "145.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "8 Proc <br> (8 X 128 GiB)", "x": 6281, "text": "6278MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}, {"xref": "x2", "yref": "y2", "y": "9 Proc <br> (9 X 128 GiB)", "x": 148.0, "text": "168.0us", "font": {"family": "Arial", "size": 12, "color": "rgb(128, 0, 128)"}, "showarrow": false}, {"xref": "x1", "yref": "y1", "y": "9 Proc <br> (9 X 128 GiB)", "x": 6381, "text": "6378MiB/s", "font": {"family": "Arial", "size": 12, "color": "rgb(4, 50, 124)"}, "showarrow": false}]}, {"showLink": false, "linkText": "Export to plot.ly"})</script>
</div>
Woohoo! if the data is highly compressible, ZFS munches it much faster because there are fewer disk writes. Infact, at peak throughput the disks were averaging only about 5 MiB/s. 


Looking at the data together, 

<div class="overflow-auto">
    <table class="f6 w-100 mw8 pt3 center helvetica" cellspacing="0">
      <thead>
        <tr>
          <th class="fw6 bb b--black-20 tl pb3 pr3 bg-white"> </th>
          <th class="fw6 bb b--black-20 tl pb3 pr3 bg-white">0% compressibility</th>
          <th class="fw6 bb b--black-20 tl pb3 pr3 bg-white">50% compressibility</th>
          <th class="fw6 bb b--black-20 tl pb3 pr3 bg-white">100% compressibility</th>
        </tr>
      </thead>
      <tbody class="lh-copy">
        <tr>
          <td class="pv1 pr3 bb b--black-20">1 Proc <br> (1 X 128 GiB) <br> dataset size = 128 GiB</td>
          <td class="pv1 pr3 bb b--black-20 tc">1623 MiB/s @ 45 us </td>
          <td class="pv1 pr3 bb b--black-20 tc">1756 MiB/s @ 50 us</td>
          <td class="pv1 pr3 bb b--black-20 tc">2491 MiB/s @ 44 us</td>
        </tr>
        <tr>
          <td class="pv1 pr3 bb b--black-20">2 Procs <br> (2 X 128 GiB) <br> dataset size = 256 GiB</td>
          <td class="pv1 pr3 bb b--black-20 tc">2597 MiB/s @ 61 us</td>
          <td class="pv1 pr3 bb b--black-20 tc">2623 MiB/s @ 70 us</td>
          <td class="pv1 pr3 bb b--black-20 tc">4606 MiB/s @ 47 us</td>
        </tr>
        <tr>
          <td class="pv1 pr3 bb b--black-20">3 Proc <br> (3 X 128 GiB) <br> dataset size = 384 GiB</td>
          <td class="pv1 pr3 bb b--black-20 tc">2954 MiB/s @ 90 us</td>
          <td class="pv1 pr3 bb b--black-20 tc">2050 MiB/s @ 153 us</td>
          <td class="pv1 pr3 bb b--black-20 tc">5950 MiB/s @ 55 us</td>
        </tr>
        <tr>
          <td class="pv1 pr3 bb b--black-20">4 Proc <br> (4 X 128 GiB) <br> dataset size = 512 GiB</td>
          <td class="pv1 pr3 bb b--black-20 tc">2798 MiB/s @ 139 us</td>
          <td class="pv1 pr3 bb b--black-20 tc">2122 MiB/s @ 202 us</td>
          <td class="pv1 pr3 bb b--black-20 tc">6154 MiB/s @ 68 us</td>
        </tr>
        <tr>
          <td class="pv1 pr3 bb b--black-20">5 Proc <br> (5 X 128 GiB) <br> dataset size = 640 GiB</td>
          <td class="pv1 pr3 bb b--black-20 tc">2528 MiB/s @ 206 us</td>
          <td class="pv1 pr3 bb b--black-20 tc">2388 MiB/s @ 247 us</td>
          <td class="pv1 pr3 bb b--black-20 tc">6548 MiB/s @ 85 us</td>
        </tr>
        <tr>
          <td class="pv1 pr3 bb b--black-20">6 Proc <br> (6 X 128 GiB) <br> dataset size = 768 GiB</td>
          <td class="pv1 pr3 bb b--black-20 tc">2708 MiB/s @ 234 us</td>
          <td class="pv1 pr3 bb b--black-20 tc">2414 MiB/s @ 279 us</td>
          <td class="pv1 pr3 bb b--black-20 tc">6592 MiB/s @ 103 us</td>
        </tr>
        <tr>
          <td class="pv1 pr3 bb b--black-20">7 Proc <br> (7 X 128 GiB) <br> dataset size = 896 GiB</td>
          <td class="pv1 pr3 bb b--black-20 tc">2625 MiB/s @ 292 us</td>
          <td class="pv1 pr3 bb b--black-20 tc">2210 MiB/s @ 364 us</td>
          <td class="pv1 pr3 bb b--black-20 tc">6510 MiB/s @ 122 us</td>
        </tr>
        <tr>
          <td class="pv1 pr3 bb b--black-20">8 Proc <br> (8 X 128 GiB) <br> dataset size = 1024 GiB</td>
          <td class="pv1 pr3 bb b--black-20 tc">2565 MiB/s @ 350 us</td>
          <td class="pv1 pr3 bb b--black-20 tc">2295 MiB/s @ 401 us</td>
          <td class="pv1 pr3 bb b--black-20 tc">6278 MiB/s @ 145 us</td>
        </tr>
        <tr>
          <td class="pv1 pr3 bb b--black-20">9 Proc <br> (9 X 128 GiB) <br> dataset size = 1152 GiB</td>
          <td class="pv1 pr3 bb b--black-20 tc">2674 MiB/s @ 379 us</td>
          <td class="pv1 pr3 bb b--black-20 tc">2332 MiB/s @ 447 us</td>
          <td class="pv1 pr3 bb b--black-20 tc">6348 MiB/s @ 168 us</td>
        </tr>
      </tbody>
    </table>
  </div>

<p>Out of curiosity, I took a look at the performance of the system while the IO test was in progress. Here are some pleasant sights I had.</p>

<p>Overall disk bandwidth slightly less than 3 GB per second!</p>

<p><img class="pt1 mw6-ns" src="/images/zpool_iostat.png" class="w-100 f5 center" alt="zpool iostat showing disk util"></img></p>

<p>To put this in perspective, the network interface on this server is a 10Gbps link.</p>

<p><code>10Gbps</code> = <code>1250 MB/s</code> or <code>1192 MiB/s</code>.</p>

<blockquote class="athelas ml0 mt0 pl4 black-90 bl bw2 b--blue">
    <div class="f5 f4-m f3-l i lh-copy measure mt0">
      Our backup server is servicing writes faster than the 10 Gbps network it is connected to!
    </div>
</blockquote>

<p>While this is happening, here is htop..
<img class="pt3" src="/images/htop_zfs.png" class="w-100 f5 " alt="HTOP view"></img>
Good that the fio processes are not CPU bound.</p>

<p>Here is another view of individual disk&rsquo;s util through systat..
<img class="pt3" src="/images/systat.png" class="w-100 f5 " alt="systat view of ZFS"></img>
Ok, so each of these disks are doing approximately 30 MiB/s. However, the manufacturer rating of these disks are 237 MiB/s..</p>

<p><img class="pt3 mw6-ns" src="/images/disk_rating_perf.png" class="w-100 f5 " alt="disk rating from manufacturer"></img></p>

<p>Deriving performance out of disks is more complicated than this. The manufacturer ratings dont apply for all conditions in which the IO hits the disks. IO sizes often play a big role in determining max throughput from a disk. Another factor is caching infront of the disks, and in the storage drivers. As an example of such wild swings, here is a snip from Matthew Rocklin&rsquo;s research into disk throughput vs file size.</p>

<p><img class="pt3" src="/images/disk-bandwidth-by-file-size.png" class="w-100 f5 " alt="disk bw by file size.."></img></p>

<p>There may be opportunities to remove bottlenecks and further improve performance. But, that would be useless when the 10Gbps network is already a bottleneck.</p>

<h3 id="conclusion">Conclusion</h3>

<p>It was fun looking at the performance of the ZFS server in the context it will be used at. I&rsquo;m amazed particularly by how ZFS handle compressible data with ease. At some point it should become the default. Knowing that the system I built exceeded performance goals is always good. Hopefully, these notes above helps others tailor their test cases to anlyze different scenarios.</p>
</div>
    <div class="w-100 w-30-ns pl1 pl4-ns mt4-ns"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links Alegreya">
    <p class="f5 b mb3">What's in this Post</p>
      <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#context">Context</a></li>
<li><a href="#performance">Performance</a></li>
<li><a href="#methodology">Methodology</a></li>
<li><a href="#write-performance-with-fio">Write performance with fio</a>
<ul>
<li><a href="#test-setup">Test setup:</a></li>
</ul></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links Alegreya">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/post/zfs_fileserver/">ZFS file server</a>
        </li>
	    
    </ul>
</div>

</div>

</main>

    </main>
    <footer class="pv1 ph3 ph5-m ph6-l bg-black">
	<div class="tc">
    	<a class="light-gray f3 f2-ns fw5 tc link dim dib mt4 mb4 mb0-l Alegreya-sans" href="mailto:aravindh@fastmail.com" >
        	aravindh@fastmail.com
    	</a>
  </div>
  <div class="tc mt3 mb6">
    	<a class="link near-white hover-blue dib h2 w2 mr3" href="https://github.com/aravindhsampath" title="GitHub">
      		<svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M8 0C3.58 0 0 3.582 0 8c0 3.535 2.292 6.533 5.47 7.59.4.075.547-.172.547-.385 0-.19-.007-.693-.01-1.36-2.226.483-2.695-1.073-2.695-1.073-.364-.924-.89-1.17-.89-1.17-.725-.496.056-.486.056-.486.803.056 1.225.824 1.225.824.714 1.223 1.873.87 2.33.665.072-.517.278-.87.507-1.07-1.777-.2-3.644-.888-3.644-3.953 0-.873.31-1.587.823-2.147-.083-.202-.358-1.015.077-2.117 0 0 .672-.215 2.2.82.638-.178 1.323-.266 2.003-.27.68.004 1.364.092 2.003.27 1.527-1.035 2.198-.82 2.198-.82.437 1.102.163 1.915.08 2.117.513.56.823 1.274.823 2.147 0 3.073-1.87 3.75-3.653 3.947.287.246.543.735.543 1.48 0 1.07-.01 1.933-.01 2.195 0 .215.144.463.55.385C13.71 14.53 16 11.534 16 8c0-4.418-3.582-8-8-8"/></svg>
    	</a>
    	<a href="https://www.facebook.com/aravindh.sathish" class="link dim dib mr3 near-white" title="Impossible Labs on Facebook">
        	<svg class="db w2 h2" data-icon="facebook" viewBox="0 0 32 32" fill="currentColor">
          	<title >facebook icon</title>
          	<path d="M8 12 L13 12 L13 8 C13 2 17 1 24 2 L24 7 C20 7 19 7 19 10 L19 12 L24 12 L23 18 L19 18 L19 30 L13 30 L13 18 L8 18 z">	
          		</path>
        	</svg>
    	</a>
    	<a href="https://twitter.com/reacharavindh" class="link dim dib mr3 near-white">
        	<svg class="db w2 h2" data-icon="twitter" viewBox="0 0 32 32"
          		fill="currentColor" >
          		<title >twitter icon</title>
          		<path d="M2 4 C6 8 10 12 15 11 A6 6 0 0 1 22 4 A6 6 0 0 1 26 6 A8 8 0 0 0 31 4 A8 8 0 0 1 28 8 A8 8 0 0 0 32 7 A8 8 0 0 1 28 11 A18 18 0 0 1 10 30 A18 18 0 0 1 0 27 A12 12 0 0 0 8 24 A8 8 0 0 1 3 20 A8 8 0 0 0 6 19.5 A8 8 0 0 1 0 12 A8 8 0 0 0 3 13 A8 8 0 0 1 2 4">
          		</path>
        	</svg>
    	</a>
    	<a href="https://www.linkedin.com/aravindhsampath" class="link dim dib black-30">
        	<svg class="db w2 h2" x="0px" y="0px" viewBox="0 0 48 48" >
          		<linearGradient gradientUnits="userSpaceOnUse" x1="23.9995"
            		y1="0" x2="23.9995" y2="48.0005" >
            		<stop offset="0" ></stop>
            		<stop offset="1" ></stop>
          		</linearGradient>
          		<path fill="currentColor" d="M48,42c0,3.313-2.687,6-6,6H6c-3.313,0-6-2.687-6-6V6 c0-3.313,2.687-6,6-6h36c3.313,0,6,2.687,6,6V42z">
          		</path>
          		<g >
            		<g >
              			<path fill="#FFFFFF" d="M15.731,11.633c-1.608,0-2.658,1.083-2.625,2.527c-0.033,1.378,1.018,2.494,2.593,2.494 c1.641,0,2.691-1.116,2.691-2.494C18.357,12.716,17.339,11.633,15.731,11.633z M13.237,35.557h4.988V18.508h-4.988V35.557z M31.712,18.748c-1.595,0-3.222-0.329-4.956,2.36h-0.099l-0.087-2.599h-4.417c0.065,1.411,0.074,3.518,0.074,5.52v11.529h4.988 v-9.854c0-0.46,0.065-0.919,0.196-1.248c0.328-0.919,1.149-1.871,2.527-1.871c1.805,0,2.527,1.411,2.527,3.479v9.494h4.988V25.439 C37.455,20.713,34.993,18.748,31.712,18.748z">
              			</path>
            		</g>
         		</g>
        	</svg>
    	</a>
  	</div>

</footer>
</body>
</html>

    

  <script async src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
